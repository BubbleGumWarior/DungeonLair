<div class="magic-battle-container">
  <!-- Top Action Buttons: Desktop Layout -->
  <div *ngIf="!isMobile" class="magic-action-bar">
    <button *ngIf="userInformation.role !== 'Dungeon Master'" (click)="confirmJoinLeaveBattle()" class="magic-action-button magic-button-primary">
        Join/Leave Battle
    </button>
    <button *ngIf="userInformation.role !== 'Dungeon Master'" (click)="useMainAction()" [ngClass]="canUseMainAction() ? 'magic-button-primary' : 'magic-button-disabled'" class="magic-action-button">
       Use Skill
    </button>
    <button *ngIf="userInformation.role === 'Dungeon Master'" (click)="openAddMaskModal()" class="magic-action-button magic-button-primary">
      Add a Mask
    </button>
    <button *ngIf="userInformation.role === 'Dungeon Master'" (click)="useMask()" class="magic-action-button magic-button-success">
      Use a Mask
    </button>
    <button *ngIf="userInformation.role === 'Dungeon Master'" (click)="continue()" class="magic-action-button magic-button-warning">
        Continue
    </button>
    <button *ngIf="userInformation.role === 'Dungeon Master'" (click)="openAssignTeamsModal()" class="magic-action-button magic-button-purple">
      Assign Teams
    </button>
    <button *ngIf="userInformation.role === 'Dungeon Master'" (click)="removeMask()" class="magic-action-button magic-button-danger">
      Remove a Mask
    </button>
    <button *ngIf="userInformation.role === 'Dungeon Master'" (click)="clearHealth()" class="magic-action-button magic-button-orange">
      Reset Health
    </button>
    <button *ngIf="userInformation.role === 'Dungeon Master'" (click)="endBattle()" class="magic-action-button magic-button-danger">
      End Battle
    </button>
    <button (click)="leaveBattle()" class="magic-action-button magic-button-exit">
        Return to Home Page
    </button>
  </div>

  <!-- Top Action Buttons: Mobile Layout -->
  <div *ngIf="isMobile" class="magic-action-bar-mobile">
    <button *ngIf="userInformation.role !== 'Dungeon Master'" (click)="confirmJoinLeaveBattle()" class="magic-action-button-mobile magic-button-primary">
        Join/Leave Battle
    </button>
    <button *ngIf="userInformation.role !== 'Dungeon Master'" (click)="useMainAction()" [ngClass]="canUseMainAction() ? 'magic-button-primary' : 'magic-button-disabled'" class="magic-action-button-mobile">
       Use Skill
    </button>
    <button *ngIf="userInformation.role === 'Dungeon Master'" (click)="openAddMaskModal()" class="magic-action-button-mobile magic-button-primary">
      Add a Mask
    </button>
    <button *ngIf="userInformation.role === 'Dungeon Master'" (click)="useMask()" class="magic-action-button-mobile magic-button-success">
      Use a Mask
    </button>
    <button *ngIf="userInformation.role === 'Dungeon Master'" (click)="continue()" class="magic-action-button-mobile magic-button-warning">
        Continue
    </button>
    <button *ngIf="userInformation.role === 'Dungeon Master'" (click)="openAssignTeamsModal()" class="magic-action-button-mobile magic-button-purple">
      Assign Teams
    </button>
    <button *ngIf="userInformation.role === 'Dungeon Master'" (click)="removeMask()" class="magic-action-button-mobile magic-button-danger">
      Remove a Mask
    </button>
    <button *ngIf="userInformation.role === 'Dungeon Master'" (click)="clearHealth()" class="magic-action-button-mobile magic-button-orange">
      Reset Health
    </button>
    <button *ngIf="userInformation.role === 'Dungeon Master'" (click)="endBattle()" class="magic-action-button-mobile magic-button-danger">
      End Battle
    </button>
    <button (click)="leaveBattle()" class="magic-action-button-mobile magic-button-exit">
        Return to Home Page
    </button>
  </div>

  <!-- Status Banners -->
  <div *ngIf="showErrorBanner" class="magic-error-banner">
    <span>{{ errorMessage }}</span>
  </div>

  <div *ngIf="showTargetBanner && selectedSkill?.isMultiTarget" class="magic-target-banner">
    <span>Choose target {{ selectedTargets.length + 1 }} of {{ selectedSkill?.amountOfStrikes || 1 }} of skill {{ selectedSkill?.skillName }}</span>
    <button (click)="cancelSkillSelection()" class="magic-banner-button magic-button-warning">Cancel</button>
  </div>

  <div *ngIf="showTargetBanner && !selectedSkill?.isMultiTarget" class="magic-target-banner">
    <span>Choose target of skill {{ selectedSkill?.skillName }}</span>
    <button (click)="cancelSkillSelection()" class="magic-banner-button magic-button-warning">Cancel</button>
  </div>

  <div *ngIf="showRemoveMaskBanner" class="magic-remove-banner">
    <span>Select a mask to remove</span>
    <button (click)="cancelRemoveMaskSelection()" class="magic-banner-button magic-button-danger">Cancel</button>
  </div>

  <div *ngIf="showUseMaskBanner" class="magic-use-banner">
    <span>Select a mask to use</span>
    <button (click)="showUseMaskBanner = false" class="magic-banner-button magic-button-success">Cancel</button>
  </div>

  <!-- Battle Grid: Desktop Layout -->
  <div *ngIf="!isMobile" class="magic-battle-grid">
    <!-- Ally Team Column -->
    <div class="magic-team-column magic-ally-column">
      <h3 class="magic-team-title magic-ally-title">Allies</h3>
      <ul class="magic-mask-list">
        <ng-container *ngFor="let mask of masksInBattle">
          <li *ngIf="mask.team === 'Ally'" (click)="showUseMaskBanner ? selectMaskForUse(mask) : (showRemoveMaskBanner ? selectMaskForRemoval(mask) : selectTarget(mask))" (mouseover)="mask.hover = true" (mouseout)="mask.hover = false" class="magic-mask-item">
            <div class="magic-mask-card" [ngClass]="{
              'magic-mask-ready': mask.action && mask.currentSpeed >= 100,
              'magic-mask-dead': mask.currentHealth === 0
            }" [class]="getBorderColor(mask)">
              <div class="magic-mask-avatar">
                <img *ngIf="mask.photo" [src]="mask.photo" alt="Mask Photo" class="magic-mask-image" [ngClass]="{'magic-mask-dead-image': mask.currentHealth === 0}" />
                <div *ngIf="mask.currentHealth === 0" class="magic-dead-overlay">
                  <div class="magic-dead-indicator">
                    <i class="fas fa-skull"></i>
                    <span>DEAD</span>
                  </div>
                </div>
              </div>
              <div class="magic-mask-info">
                <div class="magic-mask-header">
                  <div class="magic-mask-name" [style.color]="mask.randomColor">
                    Mask: {{ mask.maskID }}
                    <i class="fa-solid fa-mask magic-details-icon" (click)="openMaskDetails(mask)"></i>
                  </div>
                  <div class="magic-status-effects">
                    <div class="magic-status-item">
                      <i class="fa-solid fa-bolt-lightning text-yellow-500"></i>
                      <div>{{ mask.stunStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-fire text-orange-500"></i>
                      <div>{{ mask.burnStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-skull text-purple-500"></i>
                      <div>{{ mask.poisonStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-droplet text-red-500"></i>
                      <div>{{ mask.bleedStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-layer-group text-green-500"></i>
                      <div>{{ mask.buffStacks }}</div>
                    </div>
                  </div>
                </div>
                <div class="magic-health-bar">
                  <div class="magic-bar-bg">
                    <div class="magic-health-fill" [style.width.%]="(mask.currentHealth / mask.health) * 100"></div>
                  </div>
                </div>
                <div class="magic-speed-bar">
                  <div class="magic-bar-bg">
                    <div class="magic-speed-fill" [style.width.%]="mask.currentSpeed"></div>
                  </div>
                </div>
              </div>
            </div>
          </li>
        </ng-container>
      </ul>
    </div>

    <!-- Neutral Team Column -->
    <div class="magic-team-column magic-neutral-column">
      <h3 class="magic-team-title magic-neutral-title">Neutral</h3>
      <ul class="magic-mask-list">
        <ng-container *ngFor="let mask of masksInBattle">
          <li *ngIf="mask.team === 'Neutral'" (click)="showUseMaskBanner ? selectMaskForUse(mask) : (showRemoveMaskBanner ? selectMaskForRemoval(mask) : selectTarget(mask))" (mouseover)="mask.hover = true" (mouseout)="mask.hover = false" class="magic-mask-item">
            <div class="magic-mask-card" [ngClass]="{
              'magic-mask-ready': mask.action && mask.currentSpeed >= 100,
              'magic-mask-dead': mask.currentHealth === 0
            }" [class]="getBorderColor(mask)">
              <div class="magic-mask-avatar">
                <img *ngIf="mask.photo" [src]="mask.photo" alt="Mask Photo" class="magic-mask-image" [ngClass]="{'magic-mask-dead-image': mask.currentHealth === 0}" />
                <div *ngIf="mask.currentHealth === 0" class="magic-dead-overlay">
                  <div class="magic-dead-indicator">
                    <i class="fas fa-skull"></i>
                    <span>DEAD</span>
                  </div>
                </div>
              </div>
              <div class="magic-mask-info">
                <div class="magic-mask-header">
                  <div class="magic-mask-name" [style.color]="mask.randomColor">
                    Mask: {{ mask.maskID }}
                    <i class="fa-solid fa-mask magic-details-icon" (click)="openMaskDetails(mask)"></i>
                  </div>
                  <div class="magic-status-effects">
                    <div class="magic-status-item">
                      <i class="fa-solid fa-bolt-lightning text-yellow-500"></i>
                      <div>{{ mask.stunStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-fire text-orange-500"></i>
                      <div>{{ mask.burnStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-skull text-purple-500"></i>
                      <div>{{ mask.poisonStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-droplet text-red-500"></i>
                      <div>{{ mask.bleedStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-layer-group text-green-500"></i>
                      <div>{{ mask.buffStacks }}</div>
                    </div>
                  </div>
                </div>
                <div class="magic-health-bar">
                  <div class="magic-bar-bg">
                    <div class="magic-health-fill" [style.width.%]="(mask.currentHealth / mask.health) * 100"></div>
                  </div>
                </div>
                <div class="magic-speed-bar">
                  <div class="magic-bar-bg">
                    <div class="magic-speed-fill" [style.width.%]="mask.currentSpeed"></div>
                  </div>
                </div>
              </div>
            </div>
          </li>
        </ng-container>
      </ul>
    </div>

    <!-- Enemy Team Column -->
    <div class="magic-team-column magic-enemy-column">
      <h3 class="magic-team-title magic-enemy-title">Enemies</h3>
      <ul class="magic-mask-list">
        <ng-container *ngFor="let mask of masksInBattle">
          <li *ngIf="mask.team === 'Enemy'" (click)="showUseMaskBanner ? selectMaskForUse(mask) : (showRemoveMaskBanner ? selectMaskForRemoval(mask) : selectTarget(mask))" (mouseover)="mask.hover = true" (mouseout)="mask.hover = false" class="magic-mask-item">
            <div class="magic-mask-card" [ngClass]="{
              'magic-mask-ready': mask.action && mask.currentSpeed >= 100,
              'magic-mask-dead': mask.currentHealth === 0
            }" [class]="getBorderColor(mask)">
              <div class="magic-mask-avatar">
                <img *ngIf="mask.photo" [src]="mask.photo" alt="Mask Photo" class="magic-mask-image" [ngClass]="{'magic-mask-dead-image': mask.currentHealth === 0}" />
                <div *ngIf="mask.currentHealth === 0" class="magic-dead-overlay">
                  <div class="magic-dead-indicator">
                    <i class="fas fa-skull"></i>
                    <span>DEAD</span>
                  </div>
                </div>
              </div>
              <div class="magic-mask-info">
                <div class="magic-mask-header">
                  <div class="magic-mask-name" [style.color]="mask.randomColor">
                    Mask: {{ mask.maskID }}
                    <i class="fa-solid fa-mask magic-details-icon" (click)="openMaskDetails(mask)"></i>
                  </div>
                  <div class="magic-status-effects">
                    <div class="magic-status-item">
                      <i class="fa-solid fa-bolt-lightning text-yellow-500"></i>
                      <div>{{ mask.stunStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-fire text-orange-500"></i>
                      <div>{{ mask.burnStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-skull text-purple-500"></i>
                      <div>{{ mask.poisonStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-droplet text-red-500"></i>
                      <div>{{ mask.bleedStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-layer-group text-green-500"></i>
                      <div>{{ mask.buffStacks }}</div>
                    </div>
                  </div>
                </div>
                <div class="magic-health-bar">
                  <div class="magic-bar-bg">
                    <div class="magic-health-fill" [style.width.%]="(mask.currentHealth / mask.health) * 100"></div>
                  </div>
                </div>
                <div class="magic-speed-bar">
                  <div class="magic-bar-bg">
                    <div class="magic-speed-fill" [style.width.%]="mask.currentSpeed"></div>
                  </div>
                </div>
              </div>
            </div>
          </li>
        </ng-container>
      </ul>
    </div>
  </div>

  <!-- Battle Log Section: Desktop -->
  <div *ngIf="!isMobile" class="magic-battle-log">
    <div class="magic-log-title">Battle Log</div>
    <div class="magic-log-container" #battleMessagesContainer>
      <div *ngFor="let message of battleMessages; let i = index" class="magic-log-message" [attr.data-index]="i">
        <ng-container *ngIf="getMaskPrefixAndColor(message) as prefixAndColor">
          <span *ngIf="prefixAndColor.prefix" [style.color]="prefixAndColor.color">{{ prefixAndColor.prefix }}</span><span *ngIf="prefixAndColor.prefix">{{ message.slice(prefixAndColor.prefix.length) }}</span>
          <span *ngIf="!prefixAndColor.prefix">{{ message }}</span>
        </ng-container>
      </div>
    </div>
  </div>

  <!-- Mobile Battle Layout -->
  <div *ngIf="isMobile" class="magic-mobile-layout">
    <!-- Ally Team Section -->
    <div class="magic-mobile-team magic-ally-section">
      <h3 class="magic-mobile-team-title magic-ally-title">Allies</h3>
      <ul class="magic-mobile-mask-list">
        <ng-container *ngFor="let mask of masksInBattle">
          <li *ngIf="mask.team === 'Ally'" (click)="showUseMaskBanner ? selectMaskForUse(mask) : (showRemoveMaskBanner ? selectMaskForRemoval(mask) : selectTarget(mask))" class="magic-mobile-mask-item">
            <div class="magic-mask-card magic-mobile-mask-card" [ngClass]="{
              'magic-mask-ready': mask.action && mask.currentSpeed >= 100,
              'magic-mask-dead': mask.currentHealth === 0
            }" [class]="getBorderColor(mask)">
              <div class="magic-mask-avatar">
                <img *ngIf="mask.photo" [src]="mask.photo" alt="Mask Photo" class="magic-mask-image" [ngClass]="{'magic-mask-dead-image': mask.currentHealth === 0}" />
                <div *ngIf="mask.currentHealth === 0" class="magic-dead-overlay">
                  <div class="magic-dead-indicator">
                    <i class="fas fa-skull"></i>
                    <span>DEAD</span>
                  </div>
                </div>
              </div>
              <div class="magic-mask-info">
                <div class="magic-mask-header">
                  <div class="magic-mask-name" [style.color]="mask.randomColor">
                    Mask: {{ mask.maskID }}
                    <i class="fa-solid fa-mask magic-details-icon" (click)="openMaskDetails(mask)"></i>
                  </div>
                  <div class="magic-status-effects">
                    <div class="magic-status-item">
                      <i class="fa-solid fa-bolt-lightning text-yellow-500"></i>
                      <div>{{ mask.stunStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-fire text-orange-500"></i>
                      <div>{{ mask.burnStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-skull text-purple-500"></i>
                      <div>{{ mask.poisonStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-droplet text-red-500"></i>
                      <div>{{ mask.bleedStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-layer-group text-green-500"></i>
                      <div>{{ mask.buffStacks }}</div>
                    </div>
                  </div>
                </div>
                <div class="magic-health-bar">
                  <div class="magic-bar-bg">
                    <div class="magic-health-fill" [style.width.%]="(mask.currentHealth / mask.health) * 100"></div>
                  </div>
                </div>
                <div class="magic-speed-bar">
                  <div class="magic-bar-bg">
                    <div class="magic-speed-fill" [style.width.%]="mask.currentSpeed"></div>
                  </div>
                </div>
              </div>
            </div>
          </li>
        </ng-container>
      </ul>
    </div>

    <!-- Neutral Team Section -->
    <div class="magic-mobile-team magic-neutral-section">
      <h3 class="magic-mobile-team-title magic-neutral-title">Neutral</h3>
      <ul class="magic-mobile-mask-list">
        <ng-container *ngFor="let mask of masksInBattle">
          <li *ngIf="mask.team === 'Neutral'" (click)="showUseMaskBanner ? selectMaskForUse(mask) : (showRemoveMaskBanner ? selectMaskForRemoval(mask) : selectTarget(mask))" class="magic-mobile-mask-item">
            <div class="magic-mask-card magic-mobile-mask-card" [ngClass]="{
              'magic-mask-ready': mask.action && mask.currentSpeed >= 100,
              'magic-mask-dead': mask.currentHealth === 0
            }" [class]="getBorderColor(mask)">
              <div class="magic-mask-avatar">
                <img *ngIf="mask.photo" [src]="mask.photo" alt="Mask Photo" class="magic-mask-image" [ngClass]="{'magic-mask-dead-image': mask.currentHealth === 0}" />
                <div *ngIf="mask.currentHealth === 0" class="magic-dead-overlay">
                  <div class="magic-dead-indicator">
                    <i class="fas fa-skull"></i>
                    <span>DEAD</span>
                  </div>
                </div>
              </div>
              <div class="magic-mask-info">
                <div class="magic-mask-header">
                  <div class="magic-mask-name" [style.color]="mask.randomColor">
                    Mask: {{ mask.maskID }}
                    <i class="fa-solid fa-mask magic-details-icon" (click)="openMaskDetails(mask)"></i>
                  </div>
                  <div class="magic-status-effects">
                    <div class="magic-status-item">
                      <i class="fa-solid fa-bolt-lightning text-yellow-500"></i>
                      <div>{{ mask.stunStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-fire text-orange-500"></i>
                      <div>{{ mask.burnStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-skull text-purple-500"></i>
                      <div>{{ mask.poisonStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-droplet text-red-500"></i>
                      <div>{{ mask.bleedStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-layer-group text-green-500"></i>
                      <div>{{ mask.buffStacks }}</div>
                    </div>
                  </div>
                </div>
                <div class="magic-health-bar">
                  <div class="magic-bar-bg">
                    <div class="magic-health-fill" [style.width.%]="(mask.currentHealth / mask.health) * 100"></div>
                  </div>
                </div>
                <div class="magic-speed-bar">
                  <div class="magic-bar-bg">
                    <div class="magic-speed-fill" [style.width.%]="mask.currentSpeed"></div>
                  </div>
                </div>
              </div>
            </div>
          </li>
        </ng-container>
      </ul>
    </div>

    <!-- Enemy Team Section -->
    <div class="magic-mobile-team magic-enemy-section">
      <h3 class="magic-mobile-team-title magic-enemy-title">Enemies</h3>
      <ul class="magic-mobile-mask-list">
        <ng-container *ngFor="let mask of masksInBattle">
          <li *ngIf="mask.team === 'Enemy'" (click)="showUseMaskBanner ? selectMaskForUse(mask) : (showRemoveMaskBanner ? selectMaskForRemoval(mask) : selectTarget(mask))" class="magic-mobile-mask-item">
            <div class="magic-mask-card magic-mobile-mask-card" [ngClass]="{
              'magic-mask-ready': mask.action && mask.currentSpeed >= 100,
              'magic-mask-dead': mask.currentHealth === 0
            }" [class]="getBorderColor(mask)">
              <div class="magic-mask-avatar">
                <img *ngIf="mask.photo" [src]="mask.photo" alt="Mask Photo" class="magic-mask-image" [ngClass]="{'magic-mask-dead-image': mask.currentHealth === 0}" />
                <div *ngIf="mask.currentHealth === 0" class="magic-dead-overlay">
                  <div class="magic-dead-indicator">
                    <i class="fas fa-skull"></i>
                    <span>DEAD</span>
                  </div>
                </div>
              </div>
              <div class="magic-mask-info">
                <div class="magic-mask-header">
                  <div class="magic-mask-name" [style.color]="mask.randomColor">
                    Mask: {{ mask.maskID }}
                    <i class="fa-solid fa-mask magic-details-icon" (click)="openMaskDetails(mask)"></i>
                  </div>
                  <div class="magic-status-effects">
                    <div class="magic-status-item">
                      <i class="fa-solid fa-bolt-lightning text-yellow-500"></i>
                      <div>{{ mask.stunStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-fire text-orange-500"></i>
                      <div>{{ mask.burnStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-skull text-purple-500"></i>
                      <div>{{ mask.poisonStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-droplet text-red-500"></i>
                      <div>{{ mask.bleedStacks }}</div>
                    </div>
                    <div class="magic-status-item">
                      <i class="fa-solid fa-layer-group text-green-500"></i>
                      <div>{{ mask.buffStacks }}</div>
                    </div>
                  </div>
                </div>
                <div class="magic-health-bar">
                  <div class="magic-bar-bg">
                    <div class="magic-health-fill" [style.width.%]="(mask.currentHealth / mask.health) * 100"></div>
                  </div>
                </div>
                <div class="magic-speed-bar">
                  <div class="magic-bar-bg">
                    <div class="magic-speed-fill" [style.width.%]="mask.currentSpeed"></div>
                  </div>
                </div>
              </div>
            </div>
          </li>
        </ng-container>
      </ul>
    </div>

    <!-- Mobile Battle Log -->
    <div class="magic-mobile-battle-log">
      <div class="magic-log-title">Battle Log</div>
      <div class="magic-log-container" #battleMessagesContainer>
        <div *ngFor="let message of battleMessages; let i = index" class="magic-log-message" [attr.data-index]="i">
          <ng-container *ngIf="getMaskPrefixAndColor(message) as prefixAndColor">
            <span *ngIf="prefixAndColor.prefix" [style.color]="prefixAndColor.color">{{ prefixAndColor.prefix }}</span><span *ngIf="prefixAndColor.prefix">{{ message.slice(prefixAndColor.prefix.length) }}</span>
            <span *ngIf="!prefixAndColor.prefix">{{ message }}</span>
          </ng-container>
        </div>
      </div>
    </div>
  </div>

  <!-- Skills Modal -->
  <div *ngIf="showSkillsModal && !isMobile" class="magic-modal-overlay">
    <div class="magic-modal magic-skills-modal">
      <h2 class="magic-modal-title">Choose Your Skill</h2>
      <div class="magic-skills-grid">
        <div *ngFor="let skill of skills" 
             class="magic-skill-battle-card" 
             (click)="selectedMaskForUse ? selectSkillForMask(skill) : selectSkill(skill)" 
             [ngClass]="{
               'magic-skill-disabled': skill.cooldown > 0,
               'magic-skill-available': skill.cooldown === 0,
               'magic-skill-on-cooldown': skill.cooldown > 0
             }">
          
          <!-- Skill Header -->
          <div class="magic-skill-header">
            <h3 class="magic-skill-name">{{ skill.skillName }}</h3>
            <div class="magic-skill-cooldown" *ngIf="skill.cooldown > 0">
              <i class="fas fa-clock"></i> {{ skill.cooldown }}
            </div>
            <div class="magic-skill-ready" *ngIf="skill.cooldown === 0">
              <i class="fas fa-bolt"></i> READY
            </div>
          </div>

          <!-- Skill Description -->
          <div class="magic-skill-description">
            {{ skill.description }}
          </div>

          <!-- Skill Stats Grid -->
          <div class="magic-skill-stats-grid">
            <div class="magic-skill-stat">
              <i class="fas fa-fist-raised"></i>
              <div class="magic-skill-stat-content">
                <span class="magic-skill-stat-label">Power</span>
                <span class="magic-skill-stat-value">{{ skill.mainStat }} ({{ skill.mainStatPercentage }}%)</span>
              </div>
            </div>

            <div class="magic-skill-stat" *ngIf="skill.amountOfStrikes > 1">
              <i class="fas fa-crosshairs"></i>
              <div class="magic-skill-stat-content">
                <span class="magic-skill-stat-label">Strikes</span>
                <span class="magic-skill-stat-value">{{ skill.amountOfStrikes }}x</span>
              </div>
            </div>

            <div class="magic-skill-stat" *ngIf="skill.onHitEffect !== 'None'">
              <i class="fas fa-magic" [ngClass]="{
                'fa-heart text-green-400': skill.onHitEffect === 'Heal',
                'fa-bolt-lightning text-yellow-400': skill.onHitEffect === 'Stun',
                'fa-fire text-orange-400': skill.onHitEffect === 'Burn',
                'fa-skull text-purple-400': skill.onHitEffect === 'Poison',
                'fa-droplet text-red-400': skill.onHitEffect === 'Bleed',
                'fa-layer-group text-blue-400': skill.onHitEffect === 'Buff Stack'
              }"></i>
              <div class="magic-skill-stat-content">
                <span class="magic-skill-stat-label">Effect</span>
                <span class="magic-skill-stat-value">{{ skill.onHitEffect }}</span>
              </div>
            </div>

            <div class="magic-skill-stat" *ngIf="skill.isMultiTarget">
              <i class="fas fa-users text-purple-400"></i>
              <div class="magic-skill-stat-content">
                <span class="magic-skill-stat-label">Targeting</span>
                <span class="magic-skill-stat-value">Multi-Target</span>
              </div>
            </div>
          </div>

          <!-- Click to Use Indicator -->
          <div class="magic-skill-use-indicator" *ngIf="skill.cooldown === 0">
            <i class="fas fa-mouse-pointer"></i> Click to Use
          </div>
          <div class="magic-skill-cooldown-indicator" *ngIf="skill.cooldown > 0">
            <i class="fas fa-hourglass-half"></i> On Cooldown
          </div>
        </div>
      </div>
      
      <!-- Close Button -->
      <div class="magic-modal-buttons">
        <button (click)="closeSkillsModal()" class="magic-button-secondary">
          <i class="fas fa-times mr-2"></i>Cancel
        </button>
      </div>
    </div>
  </div>

  <div *ngIf="showSkillsModal && isMobile" class="magic-modal-overlay">
    <div class="magic-modal magic-skills-modal magic-mobile-modal">
      <h2 class="magic-modal-title">Choose Your Skill</h2>
      <div class="magic-skills-mobile-grid">
        <div *ngFor="let skill of skills" 
             class="magic-skill-battle-card magic-skill-mobile-card" 
             (click)="selectedMaskForUse ? selectSkillForMask(skill) : selectSkill(skill)" 
             [ngClass]="{
               'magic-skill-disabled': skill.cooldown > 0,
               'magic-skill-available': skill.cooldown === 0,
               'magic-skill-on-cooldown': skill.cooldown > 0
             }">
          
          <!-- Skill Header -->
          <div class="magic-skill-header">
            <h3 class="magic-skill-name">{{ skill.skillName }}</h3>
            <div class="magic-skill-cooldown" *ngIf="skill.cooldown > 0">
              <i class="fas fa-clock"></i> {{ skill.cooldown }}
            </div>
            <div class="magic-skill-ready" *ngIf="skill.cooldown === 0">
              <i class="fas fa-bolt"></i> READY
            </div>
          </div>

          <!-- Skill Description -->
          <div class="magic-skill-description">
            {{ skill.description }}
          </div>

          <!-- Skill Stats Grid -->
          <div class="magic-skill-stats-grid">
            <div class="magic-skill-stat">
              <i class="fas fa-fist-raised"></i>
              <div class="magic-skill-stat-content">
                <span class="magic-skill-stat-label">Power</span>
                <span class="magic-skill-stat-value">{{ skill.mainStat }} ({{ skill.mainStatPercentage }}%)</span>
              </div>
            </div>

            <div class="magic-skill-stat" *ngIf="skill.amountOfStrikes > 1">
              <i class="fas fa-crosshairs"></i>
              <div class="magic-skill-stat-content">
                <span class="magic-skill-stat-label">Strikes</span>
                <span class="magic-skill-stat-value">{{ skill.amountOfStrikes }}x</span>
              </div>
            </div>

            <div class="magic-skill-stat" *ngIf="skill.onHitEffect !== 'None'">
              <i class="fas fa-magic" [ngClass]="{
                'fa-heart text-green-400': skill.onHitEffect === 'Heal',
                'fa-bolt-lightning text-yellow-400': skill.onHitEffect === 'Stun',
                'fa-fire text-orange-400': skill.onHitEffect === 'Burn',
                'fa-skull text-purple-400': skill.onHitEffect === 'Poison',
                'fa-droplet text-red-400': skill.onHitEffect === 'Bleed',
                'fa-layer-group text-blue-400': skill.onHitEffect === 'Buff Stack'
              }"></i>
              <div class="magic-skill-stat-content">
                <span class="magic-skill-stat-label">Effect</span>
                <span class="magic-skill-stat-value">{{ skill.onHitEffect }}</span>
              </div>
            </div>

            <div class="magic-skill-stat" *ngIf="skill.isMultiTarget">
              <i class="fas fa-users text-purple-400"></i>
              <div class="magic-skill-stat-content">
                <span class="magic-skill-stat-label">Targeting</span>
                <span class="magic-skill-stat-value">Multi-Target</span>
              </div>
            </div>
          </div>

          <!-- Click to Use Indicator -->
          <div class="magic-skill-use-indicator" *ngIf="skill.cooldown === 0">
            <i class="fas fa-mouse-pointer"></i> Tap to Use
          </div>
          <div class="magic-skill-cooldown-indicator" *ngIf="skill.cooldown > 0">
            <i class="fas fa-hourglass-half"></i> On Cooldown
          </div>
        </div>
      </div>
      
      <!-- Close Button -->
      <div class="magic-modal-buttons">
        <button (click)="closeSkillsModal()" class="magic-button-secondary">
          <i class="fas fa-times mr-2"></i>Cancel
        </button>
      </div>
    </div>
  </div>

  <!-- Assign Teams Modal -->
  <div *ngIf="showAssignTeamsModal" class="magic-modal-overlay" (click)="closeAssignTeamsModal()">
    <div class="magic-modal magic-assign-teams-modal" (click)="$event.stopPropagation()">
      <h2 class="magic-modal-title">Assign Teams</h2>
      <div class="magic-teams-grid">
        <div class="magic-team-section">
          <h3 class="magic-team-section-title magic-ally-title">Allies</h3>
          <ul class="magic-team-member-list">
            <li *ngFor="let mask of allies" class="magic-team-member">
              <button (click)="moveLeft(mask)" class="magic-move-button" [disabled]="true">&lt;</button>
              <div class="magic-member-info">
                <img *ngIf="mask.photo" [src]="mask.photo" alt="Mask Photo" class="magic-member-avatar" />
                <span class="magic-member-name">{{ mask.maskID }}</span>
              </div>
              <button (click)="moveRight(mask)" class="magic-move-button">&gt;</button>
            </li>
          </ul>
        </div>
        <div class="magic-team-section">
          <h3 class="magic-team-section-title magic-neutral-title">Neutral</h3>
          <ul class="magic-team-member-list">
            <li *ngFor="let mask of neutral" class="magic-team-member">
              <button (click)="moveLeft(mask)" class="magic-move-button">&lt;</button>
              <div class="magic-member-info">
                <img *ngIf="mask.photo" [src]="mask.photo" alt="Mask Photo" class="magic-member-avatar" />
                <span class="magic-member-name">{{ mask.maskID }}</span>
              </div>
              <button (click)="moveRight(mask)" class="magic-move-button">&gt;</button>
            </li>
          </ul>
        </div>
        <div class="magic-team-section">
          <h3 class="magic-team-section-title magic-enemy-title">Enemies</h3>
          <ul class="magic-team-member-list">
            <li *ngFor="let mask of enemies" class="magic-team-member">
              <button (click)="moveLeft(mask)" class="magic-move-button">&lt;</button>
              <div class="magic-member-info">
                <img *ngIf="mask.photo" [src]="mask.photo" alt="Mask Photo" class="magic-member-avatar" />
                <span class="magic-member-name">{{ mask.maskID }}</span>
              </div>
              <button (click)="moveRight(mask)" class="magic-move-button" [disabled]="true">&gt;</button>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Mask Modal -->
  <div *ngIf="showAddMaskModal" class="magic-modal-overlay" (click)="closeAddMaskModal()">
    <div class="magic-modal magic-add-mask-modal" (click)="$event.stopPropagation()">
      <h2 class="magic-modal-title">Select a Mask</h2>
      <input type="text" [(ngModel)]="searchQuery" (input)="filterMaskList()" placeholder="Search masks..." class="magic-search-input" />
      <div class="magic-mask-grid">
        <div *ngFor="let mask of filteredMaskList" class="magic-mask-selection-card" (click)="selectMask(mask)">
          <div class="magic-mask-selection-info">
            <p><strong>Mask ID:</strong> {{ mask.maskID }}</p>
          </div>
          <img [src]="mask.photo" alt="Mask Photo" class="magic-mask-selection-image" />
        </div>
      </div>
      <div class="magic-modal-buttons">
        <button (click)="closeAddMaskModal()" class="magic-button-secondary">Close</button>
      </div>
    </div>
  </div>

  <!-- Confirmation Modals -->
  <div *ngIf="showConfirmationModal && !isMobile" class="magic-modal-overlay">
    <div class="magic-modal magic-confirmation-modal">
      <h2 class="magic-modal-title">Confirm Target</h2>
      <p class="magic-modal-text">The target is on your team, are you sure you want to target them?</p>
      <div class="magic-modal-buttons">
        <button (click)="confirmTargetSelection()" class="magic-button-primary">Yes</button>
        <button (click)="cancelTargetSelection()" class="magic-button-secondary">No</button>
      </div>
    </div>
  </div>

  <div *ngIf="showConfirmationModal && isMobile" class="magic-modal-overlay">
    <div class="magic-modal magic-confirmation-modal magic-mobile-modal">
      <h2 class="magic-modal-title">Confirm Target</h2>
      <p class="magic-modal-text">The target is on your team, are you sure you want to target them?</p>
      <div class="magic-modal-buttons">
        <button (click)="confirmTargetSelection()" class="magic-button-primary">Yes</button>
        <button (click)="cancelTargetSelection()" class="magic-button-secondary">No</button>
      </div>
    </div>
  </div>

  <div *ngIf="showHealConfirmationModal && !isMobile" class="magic-modal-overlay">
    <div class="magic-modal magic-confirmation-modal">
      <h2 class="magic-modal-title">Confirm Target</h2>
      <p class="magic-modal-text">The target is not on your team, are you sure you want to target them and heal them?</p>
      <div class="magic-modal-buttons">
        <button (click)="confirmTargetSelection()" class="magic-button-primary">Yes</button>
        <button (click)="cancelTargetSelection()" class="magic-button-secondary">No</button>
      </div>
    </div>
  </div>

  <div *ngIf="showHealConfirmationModal && isMobile" class="magic-modal-overlay">
    <div class="magic-modal magic-confirmation-modal magic-mobile-modal">
      <h2 class="magic-modal-title">Confirm Target</h2>
      <p class="magic-modal-text">The target is not on your team, are you sure you want to target them and heal them?</p>
      <div class="magic-modal-buttons">
        <button (click)="confirmTargetSelection()" class="magic-button-primary">Yes</button>
        <button (click)="cancelTargetSelection()" class="magic-button-secondary">No</button>
      </div>
    </div>
  </div>

  <!-- Mask Details Modals -->
  <div *ngIf="showMaskDetailsModal && !isMobile" class="magic-modal-overlay">
    <div class="magic-modal magic-mask-details-modal">
      <h2 class="magic-modal-title">Mask Details</h2>
      <div *ngIf="selectedMaskDetails" class="magic-mask-stats">
        <div class="magic-stat-row"><strong>Attack Damage:</strong> {{ Math.ceil(selectedMaskDetails.attackDamage) }}</div>
        <div class="magic-stat-row"><strong>Ability Damage:</strong> {{ Math.ceil(selectedMaskDetails.abilityDamage) }}</div>
        <div class="magic-stat-row"><strong>Protections:</strong> {{ Math.ceil(selectedMaskDetails.protections) }}</div>
        <div class="magic-stat-row"><strong>Magic Resist:</strong> {{ Math.ceil(selectedMaskDetails.magicResist) }}</div>
        <div class="magic-stat-row"><strong>Health:</strong> {{ Math.ceil(selectedMaskDetails.currentHealth) }} / {{ Math.ceil(selectedMaskDetails.health) }}</div>
        <div class="magic-stat-row"><strong>Speed:</strong> {{ Math.ceil(selectedMaskDetails.speed) }}</div>
        <div class="magic-stat-row"><strong>Current Speed:</strong> {{ Math.ceil(selectedMaskDetails.currentSpeed) }} / 100</div>
      </div>
      <div class="magic-modal-buttons">
        <button (click)="closeMaskDetailsModal()" class="magic-button-secondary">Close</button>
      </div>
    </div>
  </div>

  <div *ngIf="showMaskDetailsModal && isMobile" class="magic-modal-overlay">
    <div class="magic-modal magic-mask-details-modal magic-mobile-modal">
      <h2 class="magic-modal-title">Mask Details</h2>
      <div *ngIf="selectedMaskDetails" class="magic-mask-stats">
        <div class="magic-stat-row"><strong>Attack Damage:</strong> {{ Math.ceil(selectedMaskDetails.attackDamage) }}</div>
        <div class="magic-stat-row"><strong>Ability Damage:</strong> {{ Math.ceil(selectedMaskDetails.abilityDamage) }}</div>
        <div class="magic-stat-row"><strong>Protections:</strong> {{ Math.ceil(selectedMaskDetails.protections) }}</div>
        <div class="magic-stat-row"><strong>Magic Resist:</strong> {{ Math.ceil(selectedMaskDetails.magicResist) }}</div>
        <div class="magic-stat-row"><strong>Speed:</strong> {{ Math.ceil(selectedMaskDetails.speed) }}</div>
        <div class="magic-stat-row"><strong>Current Speed:</strong> {{ Math.ceil(selectedMaskDetails.currentSpeed) }} / 100</div>
      </div>
      <div class="magic-modal-buttons">
        <button (click)="closeMaskDetailsModal()" class="magic-button-secondary">Close</button>
      </div>
    </div>
  </div>

  <!-- Join/Leave Confirmation Modals -->
  <div *ngIf="showJoinLeaveConfirmationModal && !isMobile" class="magic-modal-overlay">
    <div class="magic-modal magic-confirmation-modal">
      <h2 class="magic-modal-title">Confirm Action</h2>
      <p class="magic-modal-text">Are you sure you want to join/leave the battle?</p>
      <div class="magic-modal-buttons">
        <button (click)="proceedJoinLeaveBattle()" class="magic-button-primary">Yes</button>
        <button (click)="cancelJoinLeaveBattle()" class="magic-button-secondary">No</button>
      </div>
    </div>
  </div>

  <div *ngIf="showJoinLeaveConfirmationModal && isMobile" class="magic-modal-overlay">
    <div class="magic-modal magic-confirmation-modal magic-mobile-modal">
      <h2 class="magic-modal-title">Confirm Action</h2>
      <p class="magic-modal-text">Are you sure you want to join/leave the battle?</p>
      <div class="magic-modal-buttons">
        <button (click)="proceedJoinLeaveBattle()" class="magic-button-primary">Yes</button>
        <button (click)="cancelJoinLeaveBattle()" class="magic-button-secondary">No</button>
      </div>
    </div>
  </div>
</div>

<!-- Voice Chat Component -->
<app-voice-chat [username]="username"></app-voice-chat>

<!-- Chat Button Component -->
<app-chat-button [newMessage]="diceResult" [username]="username || 'DefaultUser'"></app-chat-button>

<!-- Roll Button Component -->
<app-roll-button 
    (resultRolled)="handleDiceResult($event)" 
    (openChat)="openChatButton()">
</app-roll-button>